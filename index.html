<!DOCTYPE html>
<html>
<head>
<title>Conway's Game of Life - AssemblyScript</title>
<link rel="icon" href="https://assemblyscript.org/favicon.ico" type="image/x-icon" />
<meta name="viewport" content="user-scalable=0" />
<style>
html, body { height: 100%; margin: 0; overflow: hidden; color: #111; background: #fff; font-family: sans-serif; }
body { border-top: 2px solid #bc18d4; }
h1 { padding: 18px 20px 20px; font-size: 12pt; margin: 0; }
a { color: #111; text-decoration: none; }
a:hover { color: #bc18d4; text-decoration: underline; }
#edge { position: absolute; bottom: 40px; right: 40px; color: #fff; display: none; text-shadow: 0 1px 2px #000; -ms-user-select: none; user-select: none; }
</style>
</head>
<body>
<h1>
  <a href="https://en.wikipedia.org/wiki/Conway's_Game_of_Life">Conway's Game of Life</a> in
  <a href="http://assemblyscript.org">AssemblyScript</a>
  ( <a href="https://github.com/AssemblyScript/assemblyscript/blob/master/examples/game-of-life/assembly/index.ts">source</a> )
</h1>
<div id="edge">Might be blurry because MS Edge does not support 'image-rendering: crisp-edges' (yet) :-(</div>
<script>"use strict";

const byteSize = 100000;
var globalModule;
var globalExports;
// Compute the size of and instantiate the module's memory
var memory = new WebAssembly.Memory({ initial: ((byteSize + 0xffff) & ~0xffff) >>> 16 });
const utf8Decoder = new TextDecoder('utf-8');

async function main() {

try {
// Fetch and instantiate the module
const response = await fetch("/build/untouched.wasm");
const buffer = await response.arrayBuffer();
const wasmmodule = await WebAssembly.instantiate(buffer, {
  env: {
    memory,
    abort(_msg, _file, line, column) {
       console.error("abort called at index.ts:" + line + ":" + column);
    },
    proxy_log(level, logMessage, messageSize) {
        var mem = new Uint8Array(globalModule.instance.exports.memory.buffer);
        let buf = mem.slice(logMessage, logMessage + messageSize);
        let msg = String.fromCharCode.apply(null, buf);
        msg = utf8Decoder.decode(buf);
        console.info(msg.toString());
        return 0;
      },
    proxy_get_configuration(configuration_ptr, configuration_size) {
      // get memory:
      const conf_size = 5;
      let bytes = globalExports.malloc(conf_size);
      if (bytes === 0) {
        throw "can't allocate";
      }

      var moduleMemory = globalModule.instance.exports.memory.buffer;

      var confMem = new Uint8Array(moduleMemory, bytes, conf_size);
      confMem[0] = 'y'.charCodeAt(0);
      confMem[1] = 'v'.charCodeAt(0);
      confMem[2] = 'u'.charCodeAt(0);
      confMem[3] = 'a'.charCodeAt(0);
      confMem[4] = 'l'.charCodeAt(0);

      var confPtr = new Uint32Array(moduleMemory, configuration_ptr, 1);
      confPtr[0] = bytes;
      var confSizePtr = new Uint32Array(moduleMemory, configuration_size, 1);
      confSizePtr[0] = conf_size;

      console.info("configuration_ptr index.ts:" + configuration_ptr + ":" + configuration_size);
    }
  }
  });

  globalModule = wasmmodule;
  var exports = wasmmodule.instance.exports;
  globalExports = exports;
  
  // Initialize the filter
  exports.get_configuration();

} catch(err) {
  alert("Failed to load WASM: " + err.message + " (ad blocker, maybe?)");
  console.log(err);
  console.log(err.stack);
}

} //main

main();

</script>
</body>
</html>
